# Electron Desktop Client Migration - Decision Summary

## Overview

This document summarizes the key decisions made for the Electron desktop client migration based on the coding agent's questions.

**MAJOR UPDATE**: Backend conversation storage is now REQUIRED (not deferred). Uses smart hybrid approach (stateful/stateless).

---

## Quick Reference

| Topic | Decision | Status |
|-------|----------|--------|
| **Authentication** | Optional auth (match backend) | ✅ Decided |
| **Routing Mode** | UI toggle in chat interface | ✅ Decided |
| **Conversation Storage** | Backend postgres (stateful/stateless hybrid) | ✅ Decided + Plan created |
| **Reasoning Events** | No changes needed | ✅ Confirmed |
| **Model Discovery** | Proxy LiteLLM endpoint | ✅ Decided + Plan created |
| **Testing** | Incremental with Jest setup | ✅ Decided |

---

## Detailed Decisions

### 1. Authentication
**Decision**: Support optional authentication (match backend behavior)
- Desktop client reads `REASONING_API_TOKEN` from `.env`
- Sends as `Authorization: Bearer` header if token is set
- Works with `REQUIRE_AUTH=false` (dev mode) or `REQUIRE_AUTH=true` (prod mode)

### 2. Routing Mode Selection
**Decision**: Expose in chat UI, not settings panel
- Add dropdown/segmented control near message input
- Options: Passthrough (default), Reasoning, Auto
- Send `X-Routing-Mode` header on each request
- Optionally show badge on assistant messages indicating mode used

### 3. Conversation History
**Decision**: Backend postgres storage with smart stateful/stateless hybrid approach

**Smart Hybrid Approach**:

**Stateful Mode** (conversation storage):
- Client sends **only user messages** → Backend stores in postgres
- `conversation_id` provided → Backend loads history, appends new message
- `conversation_id` omitted → Backend creates new conversation, returns `conversation_id`
- Client sends only new user messages on subsequent requests

**Stateless Mode** (no storage):
- Client sends **system message** → Backend does NOT store conversation
- Client sends full message history with each request (current behavior)
- Useful for: custom system prompts, ephemeral chats, testing, programmatic use

**Rationale**:
- System message signals "I'm managing my own context"
- No system message signals "please manage my conversation for me"
- Backward compatible - existing stateless behavior preserved
- Desktop client opts into stateful mode (default: no system message)
- See: `docs/implementation_plans/2025-10-25-conversation-storage.md`

### 4. Reasoning Events
**Confirmed**: No changes to reasoning event structure
- Current format works correctly
- `delta.reasoning_event` contains structured metadata
- Reference `web-client/main.py` lines 188-389 for rendering patterns

### 5. LiteLLM Model Discovery
**Decision**: API must proxy LiteLLM's `/v1/models` endpoint

**Implementation Plan**: `docs/implementation_plans/2025-10-25-litellm-models-proxy.md`

**Changes**:
- Modify `GET /v1/models` in `api/main.py` to proxy LiteLLM
- Desktop client fetches models dynamically on startup
- Populates model selector dropdown from API response

**Benefits**:
- No hardcoded model list
- Automatically reflects `litellm_config.yaml` changes
- Supports future model additions without code changes

### 6. Testing Strategy
**Decision**: Jest + React Testing Library from start, incremental testing
- **Milestone 1**: Set up test infrastructure
- **Milestones 2-7**: Write tests incrementally (critical paths)
- **Milestone 9**: Comprehensive coverage and polish

---

## Implementation Order

### 1. Backend: LiteLLM Models Proxy (Small)
**Plan**: `docs/implementation_plans/2025-10-25-litellm-models-proxy.md`
- Modify `GET /v1/models` endpoint
- ~20 lines of code
- Unblocks desktop client Milestone 5 (settings panel)

### 2. Backend: Conversation Storage (Medium-Sized)
**Plan**: `docs/implementation_plans/2025-10-25-conversation-storage.md`
- 7 milestones (research/impact analysis, DB setup, CRUD, API changes, endpoints, client integration, final testing)
- New postgres instance (`postgres-reasoning` - consistent naming)
- Smart stateful/stateless hybrid approach
- Required for desktop client Milestone 6+
- Tests written incrementally as functionality is added

### 3. Desktop Client: Electron Migration (Main Work)
**Plan**: `docs/implementation_plans/2025-10-25-electron.md`
- 11 milestones (added conversation management UI)
- Milestones 1-5 can start while backend work happens
- Milestone 6+ blocks on backend conversation storage completion

**Parallel Work Strategy**:
- Start backend conversation storage immediately (Milestones 0-4)
- Start desktop client Milestones 1-5 in parallel
- Desktop client Milestone 6 blocks on backend Milestone 4 completion
- Enables parallel development without blocking

---

## Files Created

1. **Electron Migration Plan**: `docs/implementation_plans/2025-10-25-electron.md`
   - Main implementation plan (updated with deployment model)
   - 10 milestones with clear dependencies

2. **Agent Response**: `docs/implementation_plans/2025-10-25-electron-agent-response.md`
   - Answers to all 6 agent questions
   - Detailed implementation guidance

3. **LiteLLM Models Proxy**: `docs/implementation_plans/2025-10-25-litellm-models-proxy.md`
   - Backend change to proxy `/v1/models`
   - Required for desktop client Milestone 5

4. **Conversation Storage**: `docs/implementation_plans/2025-10-25-conversation-storage.md`
   - Future backend enhancement (deferred)
   - Design considerations and schema proposal

5. **This Summary**: `docs/implementation_plans/2025-10-25-SUMMARY.md`
   - Quick reference for all decisions

---

## Next Steps

1. **Review** these documents and approve decisions
2. **Implement** LiteLLM models proxy (backend, quick win)
3. **Start** Electron migration with coding agent
4. **Defer** conversation storage to post-Electron work

---

## Open Questions

None - all agent questions have been answered with clear decisions.
